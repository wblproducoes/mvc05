{% extends "layout/base.twig" %}

{% block title %}Instalação - {{ app_name }}{% endblock %}

{% block body_class %}install-page{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="mb-0">
                        <i class="bi bi-gear-fill me-2"></i>
                        Instalação do Sistema
                    </h2>
                    <p class="mb-0 mt-2">{{ app_name }}</p>
                </div>

                <div class="card-body p-4">
                    <!-- Flash Messages -->
                    {% if flash_messages %}
                        {% for message in flash_messages %}
                            <div class="alert alert-{{ message.type }} alert-dismissible fade show" role="alert">
                                {{ message.message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Verificação de Requisitos -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-check-circle me-2"></i>
                            Verificação de Requisitos
                        </h5>
                        
                        <div class="list-group">
                            {% for key, requirement in requirements %}
                                {% if key != 'all_passed' %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ requirement.name }}</strong>
                                            {% if requirement.current is defined %}
                                                <br><small class="text-muted">Atual: {{ requirement.current }}</small>
                                            {% endif %}
                                            {% if requirement.required is defined %}
                                                <br><small class="text-muted">Requerido: {{ requirement.required }}+</small>
                                            {% endif %}
                                        </div>
                                        <span class="badge bg-{{ requirement.passed ? 'success' : 'danger' }}">
                                            <i class="bi bi-{{ requirement.passed ? 'check' : 'x' }}"></i>
                                            {{ requirement.passed ? 'OK' : 'Falha' }}
                                        </span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        {% if not requirements.all_passed %}
                            <div class="alert alert-warning mt-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Alguns requisitos não foram atendidos. Corrija-os antes de continuar.
                            </div>
                        {% endif %}
                    </div>

                    <!-- Configuração do Banco de Dados -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-database me-2"></i>
                            Configuração do Banco de Dados
                        </h5>
                        
                        <div class="alert alert-info">
                            <strong>Configuração Atual:</strong><br>
                            Host: {{ database_config.host }}<br>
                            Banco: {{ database_config.name }}<br>
                            Usuário: {{ database_config.user }}<br>
                            Charset: {{ database_config.charset }}
                        </div>
                        
                        <small class="text-muted">
                            Para alterar essas configurações, edite o arquivo .env na raiz do projeto.
                        </small>
                    </div>

                    <!-- Formulário de Instalação -->
                    {% if requirements.all_passed %}
                        <form method="POST" action="/install">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            
                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-person-plus me-2"></i>
                                    Criar Usuário Administrador
                                </h5>
                                
                                <div class="mb-3">
                                    <label for="admin_name" class="form-label">Nome Completo</label>
                                    <input type="text" 
                                           class="form-control {% if errors.admin_name %}is-invalid{% endif %}" 
                                           id="admin_name" 
                                           name="admin_name" 
                                           value="{{ old.admin_name ?? '' }}" 
                                           required>
                                    {% if errors.admin_name %}
                                        <div class="invalid-feedback">
                                            {{ errors.admin_name[0] }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="admin_email" class="form-label">Email</label>
                                    <input type="email" 
                                           class="form-control {% if errors.admin_email %}is-invalid{% endif %}" 
                                           id="admin_email" 
                                           name="admin_email" 
                                           value="{{ old.admin_email ?? '' }}" 
                                           required>
                                    {% if errors.admin_email %}
                                        <div class="invalid-feedback">
                                            {{ errors.admin_email[0] }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="admin_password" class="form-label">Senha</label>
                                    <input type="password" 
                                           class="form-control {% if errors.admin_password %}is-invalid{% endif %}" 
                                           id="admin_password" 
                                           name="admin_password" 
                                           required>
                                    <div class="form-text">
                                        A senha deve ter pelo menos 8 caracteres, incluindo maiúsculas, minúsculas, números e símbolos.
                                    </div>
                                    {% if errors.admin_password %}
                                        <div class="invalid-feedback">
                                            {% for error in errors.admin_password %}
                                                {{ error }}<br>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    <label for="admin_password_confirmation" class="form-label">Confirmar Senha</label>
                                    <input type="password" 
                                           class="form-control {% if errors.admin_password_confirmation %}is-invalid{% endif %}" 
                                           id="admin_password_confirmation" 
                                           name="admin_password_confirmation" 
                                           required>
                                    {% if errors.admin_password_confirmation %}
                                        <div class="invalid-feedback">
                                            {{ errors.admin_password_confirmation[0] }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5 class="mb-3">
                                    <i class="bi bi-shield-lock me-2"></i>
                                    Senha de Instalação
                                </h5>
                                
                                <div class="mb-3">
                                    <label for="install_password" class="form-label">Senha de Instalação</label>
                                    <input type="password" 
                                           class="form-control" 
                                           id="install_password" 
                                           name="install_password" 
                                           required>
                                    <div class="form-text">
                                        Esta senha está definida no arquivo .env (INSTALL_PASSWORD).
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-download me-2"></i>
                                    Instalar Sistema
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="text-center">
                            <button class="btn btn-secondary btn-lg" disabled>
                                <i class="bi bi-x-circle me-2"></i>
                                Instalação Bloqueada
                            </button>
                            <p class="text-muted mt-2">Corrija os requisitos acima para continuar.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.install-page {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.card {
    border: none;
    border-radius: 15px;
}

.card-header {
    border-radius: 15px 15px 0 0 !important;
}

.list-group-item {
    border: 1px solid rgba(0,0,0,.125);
}

.list-group-item:first-child {
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
}

.list-group-item:last-child {
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

.btn-primary {
    background: linear-gradient(45deg, #0d6efd, #6610f2);
    border: none;
    border-radius: 10px;
}

.btn-primary:hover {
    background: linear-gradient(45deg, #0b5ed7, #5a0fc8);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>
{% endblock %}